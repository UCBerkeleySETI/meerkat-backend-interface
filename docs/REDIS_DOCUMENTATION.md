# Redis Documentation
*The information made available by this interface and the format within which it is stored in redis*

# Key / Value Pairs
*Here are the redis keys that are created by the `KATCP Server` and `KATPortal Client` modules and descriptions of their values.*

### `current:obs:id` --> (string): 
The `product_id` sent with the most recent `?configure` request. A product id is specific to a subarray and will last for some period of time (over the course of observing multiple targets). Note that product ids can be repeated at different times in the telescope's lifespan, so do not use it as a unique identifier to label the data products! The product id is used as a temporary identifier of a currently activated subarray. Accordingly, metadata for this subarray is grouped with this product id. For instance, if the product id of the currently-in-use subarray #2 is `array_1_bc856M4k`, then metadata will have a redis key in the form of `array_1_bc856M4k:<type of data>`, e.g. `array_1_bc856M4k:n_channels`.

### `[product_id]:timestamp` --> (string):
The Unix time at which the `?configure` request was processed. This is generated by Python's 'time' module, with a `time.time()` function call. It is in seconds since UTC 1970-01-01 00:00:00.

### `[product_id]:antennas` --> (list):
A redis list of physical antenna names used in particular sub-array to which the product id is associated.

### `[product_id]:n_channels` --> (string):
The number of frequency channels provided by the CFB.

### `[product_id]:proxy_name` --> (string):
The CAM name for the instance of the BLUSE data proxy that is being configured.  For example, “BLUSE_3”.  This can be used to query sensors on the correct proxy.  Note that for BLUSE there will only be a single instance of the proxy in a subarray.

### `[product_id]:cam:url` --> (string):
The url used by the `KATPortal Client` module to query additional metadata for the subarray associated with the given product id.

### `[product_id]:streams` --> (string):
A json-formatted string for a python dictionary that contains different URL's for the different types of raw data that are produced in the current observation being conducted on the given product_id's subarray. To convert this string to a python dictionary, simply call `json.loads(<streams_string>)`, and it will return a python dictionary object. This dictionary will look something like this:
```
{
    "cam.http":
        {"camdata":"http://monctl.devnmk.camlab.kat.ac.za/api/client/2"},
    "stream_type1":
        {
            "stream_name1":"stream_address1",
            "stream_name2":"stream_address2"
        }
    }
    "stream_type2":
        {
            "stream_name1":"stream_address1",
            "stream_name2":"stream_address2"
        }
    }
}
```
It may contain:
* One CAM stream, with type cam.http. The camdata stream provides the connection string for katportalclient (for the subarray that this BLUSE instance is being configured on). This is the same as the `[product_id]:cam:url` value in the redis database.
* One F-engine stream, with type:  cbf.antenna_channelised_voltage.
* One X-engine stream, with type:  cbf.baseline_correlation_products.
* Two beam streams, with type: cbf.tied_array_channelised_voltage.  The stream names ending in x are horizontally polarised, and those ending in y are vertically polarised

### `[product_id]:[sensor_name]` --> (string):
Most of the keys published to redis will look like this, and are created from the `KATPortal Client` module. The `[product_id]` is that of the subarray that is queried by the `KATPortal Client`. The value of this key a repr string for a python dictionary containing sensor information. The dictionary looks like this:
```
{
    'status': u'nominal', 
    'timestamp': 1533319620.245345, 
    'value': u'PKS 0408-65, radec bfcal single_accumulation, 4:08:20.38, -65:45:09.1, (800.0 8400.0 -3.708 3.807 -0.7202)', 
    'value_timestamp': 1533291480.096976
}
```

# Messages

## Internal Channels: `alerts` and `sensor_alerts`


| Message                             | Description                                                                                      | Channel         | Publisher(s)       | Subscriber(s)                      |
|:------------------------------------|:---------------------------------------------------------------------------------------------------|:----------------|:-------------------|:-----------------------------------|
| `configure:[product_id]`            | Published when a configure request is received, indicating that a subarray has been built.         | `alerts`        | `katcp_server`     | `katportal_server`, `coordinator`  |
| `conf_complete:[product_id]`        | Published once all sensor values required at subarray configuration time have been acquired        | `alerts`        | `katcp_server`     | `katportal_server`, `coordinator`  |
| `capture-init:[product_id]`         | Published when a capture-init request is received, indicating that a program block is starting.    | `alerts`        | `katcp_server`     | `katportal_server`, `coordinator`  |
| `capture-start:[product_id]`        | Published when a capture-start request is received, indicating the start of an observation.        | `alerts`        | `katcp_server`     | `katportal_server`, `coordinator`  |
| `capture-stop:[product_id]`         | Published when a capture-stop request is received, indicating the end of an observation.           | `alerts`        | `katcp_server`     | `katportal_server`, `coordinator`  |
| `capture-done:[product_id]`         | Published when a capture-done request is received, indicating the end of a program block.          | `alerts`        | `katcp_server`     | `katportal_server`, `coordinator`  |
| `deconfigure:[product_id]`          | Published when a deconfigure request is received, indicating that a subarray has been broken down. | `alerts`        | `katcp_server`     | `katportal_server`, `coordinator`  |
| `[product_id]:data_suspect:[value]` | Value of `data-suspect` for the full subarray (`False` if all antennas report `False`.             | `sensor_alerts`        | `katcp_server`     | `katportal_server`, `coordinator`  |
| `[product_id]:target:[value]`       | Current target under observation.                                                                  | `sensor_alerts`        | `katcp_server`     | `katportal_server`, `coordinator`  |

## Hashpipe-Redis Gateway

SPEAD stream addresses are published along with other information to individual channels, one each per processing instance. An example of a channel: `bluse://blpn48/0/set`. The messages published to this channel are formatted for use with the hashpipe-redis gateway. Messages published to the channel `[HPGDOMAIN]:///set ` are received by all processing instances.

| Message                           | Description                                                                                      | Channel                                 |
|:----------------------------------|:-------------------------------------------------------------------------------------------------|:----------------------------------------|
| `NCHAN=[num channels]`            | To Be Deleted                                                                                    | `[HPGDOMAIN]://[hashpipe_instance]/set` |
|                                   | test                                                                                                 |                                         |
| `NSTRM=[num streams]`             | Number of streams apportioned to each processing instance.                                       | `[HPGDOMAIN]://[hashpipe_instance]/set` | 
| `DESTIP=[SPEAD addresses]`        | IP addresses for SPEAD streams.                                                                  | `[HPGDOMAIN]://[hashpipe_instance]/set` |
| `SCHAN=[first starting channel]`  | Absolute starting channel number for a particular instance.                                      | `[HPGDOMAIN]://[hashpipe_instance]/set` |
| `DESTIP=[port]`                   | Port number for SPEAD streams.                                                                   | `[HPGDOMAIN]:///set`                    |
| `DESTIP=0.0.0.0`                  | Message to unsubscribe to streams (sent on deconfigure).                                         | `[HPGDOMAIN]:///set`                    |  
| `NETSTAT=RECORD`                  | Message to start recording data, sent when`capture-start` is published to the `alerts` channel.  | `[HPGDOMAIN]:///set`                    |
| `NETSTAT=LISTEN`                  | Message to stop recording data, sent when `capture-stop` is published to the `alerts` channel.   | `[HPGDOMAIN]:///set`                    |
| `FENCHAN=[num channels]`          | Total number of channels received on configure.                                                  | `[HPGDOMAIN]:///set`                    |
| `FENSTRM=[num streams]`           | Total number of streams received on configure.                                                   | `[HPGDOMAIN]:///set`                    |
| `HNCHAN=[channels per substream]` | Number of channels per substream.                                                                | `[HPGDOMAIN]:///set`                    |
| `HNTIME=[spectra per heap]`       | Number of spectra per heap.                                                                      | `[HPGDOMAIN]:///set`                    |
| `SYNCTIME=[sync time]`            | UNIX sync time, obtained when `configure` is published to the `alerts` channel.                  | `[HPGDOMAIN]:///set`                    |
| `HCLOCKS=[ADC samples per heap]`  | Number of ADC samples per heap.                                                                  | `[HPGDOMAIN]:///set`                    |
| `NANTS=[num antennas]`            | Number of antennas in the subarray.                                                              | `[HPGDOMAIN]:///set`                    |




